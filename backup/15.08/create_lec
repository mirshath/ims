<?php
include './database/connection.php';

// Fetch programs for checkboxes
$sql = "SELECT * FROM program_table";
$result = mysqli_query($conn, $sql);
$programs = [];
while ($row = mysqli_fetch_assoc($result)) {
    $programs[] = $row;
}

// Handle form submission for adding or updating lecturers
if ($_SERVER["REQUEST_METHOD"] == "POST") {
    $id = $_POST['id'] ?? '';
    $title = mysqli_real_escape_string($conn, $_POST['title']);
    $lecturer_name = mysqli_real_escape_string($conn, $_POST['lecturer_name']);
    $hourly_rate = mysqli_real_escape_string($conn, $_POST['hourly_rate']);
    $qualification = mysqli_real_escape_string($conn, $_POST['qualification']);
    $selected_programs = $_POST['programs'] ?? [];
    $programs_str = implode(',', array_map([$conn, 'real_escape_string'], $selected_programs)); // Convert array to comma-separated string

    if ($id) {
        // Update lecturer
        $sql = "UPDATE lecturer_table 
                SET title = '$title', lecturer_name = '$lecturer_name', hourly_rate = '$hourly_rate', 
                    qualification = '$qualification', programs = '$programs_str' 
                WHERE id = $id";
        $message = "Lecturer updated successfully";
    } else {
        // Add new lecturer
        $sql = "INSERT INTO lecturer_table (title, lecturer_name, hourly_rate, qualification, programs) 
                VALUES ('$title', '$lecturer_name', '$hourly_rate', '$qualification', '$programs_str')";
        $message = "New lecturer added successfully";
    }

    if (mysqli_query($conn, $sql)) {
        echo "<div class='alert alert-success'>$message</div>";
    } else {
        echo "Error: " . $sql . "<br>" . mysqli_error($conn);
    }
}

// Handle deletion of lecturers
if (isset($_GET['delete_id'])) {
    $delete_id = (int)$_GET['delete_id'];
    $sql = "DELETE FROM lecturer_table WHERE id = $delete_id";

    if (mysqli_query($conn, $sql)) {
        header("Location: " . $_SERVER['PHP_SELF']); // Redirect to self to refresh page
        exit;
    } else {
        echo "Error: " . $sql . "<br>" . mysqli_error($conn);
    }
}

// Fetch lecturers for display
$lecturers = [];
$sql = "SELECT * FROM lecturer_table";
$result = mysqli_query($conn, $sql);
while ($row = mysqli_fetch_assoc($result)) {
    $lecturers[] = $row;
}
?>

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <title>Lecturer Management</title>
</head>

<body>
    <div class="container mt-5">
        <h2>Add Lecturer</h2>
        <form method="POST" action="">
            <input type="hidden" name="id" id="modalId" value="">
            <div class="mb-3">
                <label for="title" class="form-label">Title</label>
                <select name="title" id="title" class="form-select" required>
                    <option value="Mr">Mr</option>
                    <option value="Mrs">Mrs</option>
                    <option value="Ms">Ms</option>
                    <option value="Dr">Dr</option>
                    <option value="Prof">Prof</option>
                </select>
            </div>
            <div class="mb-3">
                <label for="lecturer_name" class="form-label">Lecturer Name</label>
                <input type="text" name="lecturer_name" id="lecturer_name" class="form-control" required>
            </div>
            <div class="mb-3">
                <label for="hourly_rate" class="form-label">Hourly Rate</label>
                <input type="number" name="hourly_rate" id="hourly_rate" class="form-control" step="0.01" required>
            </div>
            <div class="mb-3">
                <label for="qualification" class="form-label">Qualification</label>
                <textarea name="qualification" id="qualification" class="form-control" rows="3" required></textarea>
            </div>
            <div class="mb-3">
                <label>Programs</label>
                <?php foreach ($programs as $program): ?>
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" name="programs[]" value="<?php echo htmlspecialchars($program['program_name']); ?>">
                        <label class="form-check-label"><?php echo htmlspecialchars($program['program_name']); ?></label>
                    </div>
                <?php endforeach; ?>
            </div>
            <button type="submit" class="btn btn-primary">Add Lecturer</button>
        </form>

        <hr>

        <h2>Lecturer List</h2>
        <table class="table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Title</th>
                    <th>Name</th>
                    <th>Hourly Rate</th>
                    <th>Qualification</th>
                    <th>Programs</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <?php foreach ($lecturers as $lecturer): ?>
                    <tr>
                        <td><?php echo htmlspecialchars($lecturer['id']); ?></td>
                        <td><?php echo htmlspecialchars($lecturer['title']); ?></td>
                        <td><?php echo htmlspecialchars($lecturer['lecturer_name']); ?></td>
                        <td><?php echo htmlspecialchars($lecturer['hourly_rate']); ?></td>
                        <td><?php echo htmlspecialchars($lecturer['qualification']); ?></td>
                        <td><?php echo htmlspecialchars($lecturer['programs']); ?></td>
                        <td>
                            <button class="btn btn-warning btn-sm"
                                onclick="openEditModal(
                                    <?php echo htmlspecialchars($lecturer['id']); ?>,
                                    '<?php echo htmlspecialchars($lecturer['title']); ?>',
                                    '<?php echo htmlspecialchars($lecturer['lecturer_name']); ?>',
                                    '<?php echo htmlspecialchars($lecturer['hourly_rate']); ?>',
                                    '<?php echo htmlspecialchars($lecturer['qualification']); ?>',
                                    '<?php echo htmlspecialchars($lecturer['programs']); ?>'
                                )">
                                Edit
                            </button>
                            <a href="?delete_id=<?php echo htmlspecialchars($lecturer['id']); ?>" class="btn btn-danger btn-sm" onclick="return confirm('Are you sure you want to delete this lecturer?')">Delete</a>
                        </td>
                    </tr>
                <?php endforeach; ?>
            </tbody>
        </table>
    </div>

    <!-- Edit Lecturer Modal -->
    <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editModalLabel">Edit Lecturer</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form method="POST" action="">
                        <input type="hidden" name="id" id="modalId">
                        <div class="mb-3">
                            <label for="modalTitle" class="form-label">Title</label>
                            <select name="title" id="modalTitle" class="form-select" required>
                                <option value="Mr">Mr</option>
                                <option value="Mrs">Mrs</option>
                                <option value="Ms">Ms</option>
                                <option value="Dr">Dr</option>
                                <option value="Prof">Prof</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="modalLecturerName" class="form-label">Lecturer Name</label>
                            <input type="text" name="lecturer_name" id="modalLecturerName" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label for="modalHourlyRate" class="form-label">Hourly Rate</label>
                            <input type="number" name="hourly_rate" id="modalHourlyRate" class="form-control" step="0.01" required>
                        </div>
                        <div class="mb-3">
                            <label for="modalQualification" class="form-label">Qualification</label>
                            <textarea name="qualification" id="modalQualification" class="form-control" rows="3" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label>Programs</label>
                            <?php foreach ($programs as $program): ?>
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input" name="programs[]" value="<?php echo htmlspecialchars($program['program_name']); ?>" class="modalProgramCheckbox">
                                    <label class="form-check-label"><?php echo htmlspecialchars($program['program_name']); ?></label>
                                </div>
                            <?php endforeach; ?>
                        </div>
                        <button type="submit" class="btn btn-primary">Update Lecturer</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        function openEditModal(id, title, lecturerName, hourlyRate, qualification, programs) {
            $('#modalId').val(id);
            $('#modalTitle').val(title);
            $('#modalLecturerName').val(lecturerName);
            $('#modalHourlyRate').val(hourlyRate);
            $('#modalQualification').val(qualification);

            // Check the programs
            $('.modalProgramCheckbox').each(function() {
                $(this).prop('checked', programs.split(',').includes($(this).val()));
            });

            var myModal = new bootstrap.Modal(document.getElementById('editModal'));
            myModal.show();
        }
    </script>
</body>

</html>